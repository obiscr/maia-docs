---
title: 本地 Docker 运行
description: 从源码构建 Maia，并使用 Docker Compose 运行 App + Runner。
---

import { Aside, LinkCard, Steps, Tabs, TabItem } from "@astrojs/starlight/components"

本指南会从 **源码仓库** 启动 Maia，但运行方式是 **Docker（App + Runner）**。相比 `pnpm dev` 更接近生产环境。

## 前置要求

- Docker + Docker Compose v2
- Git

## 启动 Maia

<Steps>
1. 克隆源码仓库

   ```bash
   git clone https://github.com/obiscr/maia.git
   cd maia
   ```

2. 创建 env 文件

   ```bash
   cp env.example .env.production
   ```

3. 编辑 `.env.production`（至少需要）

   ```dotenv  title=".env.production"
   RUNNER_TOKEN=your-token
   ```

   更接近生产的推荐项：

   ```dotenv  title=".env.production" ins={2}
   RUNNER_TOKEN=your-token
   SETTINGS_ENCRYPTION_KEY=your-stable-key
   ```

4. 构建 sandbox 镜像

   ```bash
   docker build -f Dockerfile.sandbox -t maia-sandbox .
   ```

   然后在 `.env.production` 文件里设置 `MAIA_SANDBOX_IMAGE=maia-sandbox` 并重启。

   ```dotenv title=".env.production" ins={3}
   RUNNER_TOKEN=your-token
   SETTINGS_ENCRYPTION_KEY=your-stable-key
   MAIA_SANDBOX_IMAGE=maia-sandbox
   ```

5. 构建并启动

   ```bash
   docker compose --env-file .env.production up -d --build
   ```
</Steps>

启动后打开：

<LinkCard title="打开 Maia" description="Docker 默认端口：http://localhost:3690" href="http://localhost:3690" target="_blank" />

### 内网访问

如果你把 Maia 部署到服务器，并用明文 HTTP 访问（例如 `http://<IP>:3690`），可能会遇到**登录循环**：浏览器在 HTTP 下不会保存/携带带有 `Secure` 的登录会话 Cookie。

推荐做法：在 Maia 前面加一层 **HTTPS 反向代理**，并设置 `SESSION_COOKIE_SECURE=auto`。如果你明确只在可信内网并坚持纯 HTTP，可以设置 `SESSION_COOKIE_SECURE=false`（不推荐公网）。

可以参考：

- [反向代理与 HTTPS](/zh-cn/quick-start/reverse-proxy/)
- [无法登录（登录循环）](/zh-cn/troubleshooting/cant-sign-in/)

## 数据存储位置

Docker模式下，数据默认存储在 Docker named volume。如果你希望落到宿主机目录，可设置：

```dotenv title=".env.production"
MAIA_DATA_MOUNT_TYPE=bind
MAIA_HOST_DATA_DIR=/absolute/path/on/host
```

例如：

<Tabs syncKey="os">
<TabItem label="macOS">
   ```dotenv title=".env.production"
   MAIA_HOST_DATA_DIR=/Users/alice/maia-data
   ```
</TabItem>
<TabItem label="Linux">
   ```dotenv title=".env.production"
   MAIA_HOST_DATA_DIR=/home/alice/maia-data
   ```
</TabItem>
<TabItem label="Windows">
   ```dotenv title=".env.production"
   MAIA_HOST_DATA_DIR=C:\Users\alice\maia-data
   ```
</TabItem>
</Tabs>

设置完成之后需要重启容器。

## 获取更新

当 `maia` 源码有更新时，在源码目录下执行：

```bash
git pull
docker compose --env-file .env.production up -d --build --force-recreate
```

### 数据库迁移

Maia 容器在启动时会自动检测并执行新的数据库迁移。更新流程会：

1. 拉取最新代码（包含新的迁移文件）
2. 重新构建镜像（将新迁移文件打包到镜像中）
3. 重启容器时自动应用新迁移

<Aside type="note" title="迁移机制">
Maia 使用内置的迁移器读取 `prisma/migrations/` 目录，并通过 `_prisma_migrations` 表跟踪已应用的迁移。重启容器时会自动执行尚未应用的迁移。
</Aside>

如果需要手动触发迁移（例如调试），可以进入容器执行：

```bash
docker compose --env-file .env.production exec app pnpm prisma:migrate
```