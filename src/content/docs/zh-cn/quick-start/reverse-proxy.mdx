---
title: 反向代理与 HTTPS
description: 服务器部署 Maia（Docker）时，为什么必须启用 HTTPS，以及如何配置反向代理。
---

import { Aside, Steps, Tabs, TabItem } from "@astrojs/starlight/components"

Maia 使用 **Cookie session** 保存登录态。默认情况下，登录态 Cookie 会带上 `Secure` 属性（只能在 HTTPS 请求中保存/携带），以避免登录态在明文链路中泄露。

`Secure` 的含义是：**只有在 HTTPS 请求中浏览器才会保存/携带该 Cookie**。如果你用明文 HTTP 访问（例如 `http://<IP>:3690`），就会出现典型现象：

- 登录接口可能返回 **200 OK**
- 但浏览器不会保存 session Cookie（或不会在后续请求携带）
- 页面看起来“登录成功但立刻又回到登录页”（登录循环）

这是为了安全性的刻意设计。所以，**服务器上对外提供 Maia 服务时，需要让用户通过 HTTPS 访问**。最常见做法是：在 Maia 前面放一个 **终止 TLS 的反向代理**（Nginx / Caddy / 云负载均衡），代理到本机 `127.0.0.1:3690`。

<Aside>
你也可以通过环境变量 `SESSION_COOKIE_SECURE=auto|true|false` 调整该行为：

- **true / 1**：总是 `Secure`（最安全）
- **false / 0**：从不 `Secure`（不推荐公网，仅限你明确接受风险的内网 HTTP）
- **auto**：根据外部协议自动判断（依赖反向代理正确传递 `X-Forwarded-Proto` 或标准 `Forwarded`）
</Aside>


## 前置条件

要使用 Let’s Encrypt 申请免费证书，通常需要满足：

- **有一个域名**（证书签发通常不支持裸 IP，如 `http://1.2.3.4`）
- 域名的 DNS `A/AAAA` 记录指向你的服务器公网 IP
- 服务器的 **80/443** 端口对公网可达（用于校验与提供 HTTPS）

若在 **内网/无公网域名** 环境下，可以选择：

- **自签证书**（浏览器会提示不受信任，但可用）
- **公司/内网 CA**（更规范）
- **在上游网关/负载均衡处终止 HTTPS**（由网关提供证书），Maia 只接收内网 HTTP

## 使用 Caddy

Caddy 对公网域名可以自动申请/续期 Let’s Encrypt 证书，配置最简单。

<Steps>
1. 确保 Maia 在宿主机可访问：`http://127.0.0.1:3690`
2. 安装 Caddy（不同系统按官方文档）
3. 创建 `Caddyfile`
</Steps>

```nginx
maia.example.com {
  reverse_proxy 127.0.0.1:3690
}
```

启动/重载 Caddy 后，直接访问 `https://maia.example.com` 即可。

## 使用 Nginx + Certbot

### 1. 使用 Certbot 申请证书

以 Debian/Ubuntu 为例：

```bash
sudo apt-get update
sudo apt-get install -y certbot python3-certbot-nginx
sudo certbot --nginx -d maia.example.com
```

验证自动续期：

```bash
sudo certbot renew --dry-run
```

证书通常位于：

- `/etc/letsencrypt/live/maia.example.com/fullchain.pem`
- `/etc/letsencrypt/live/maia.example.com/privkey.pem`

### 2. 配置反向代理

创建 `/etc/nginx/conf.d/maia.conf`：

```nginx
server {
  listen 80;
  server_name maia.example.com;
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  server_name maia.example.com;

  ssl_certificate     /etc/letsencrypt/live/maia.example.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/maia.example.com/privkey.pem;

  location / {
    proxy_pass http://127.0.0.1:3690;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_buffering off;
    proxy_read_timeout 3600s;
  }
}
```

检查并重载：

```bash
sudo nginx -t && sudo systemctl reload nginx
```
